graph TD
    %% Define Styles
    classDef container fill:#fff,stroke:#000,stroke-width:2px;
    classDef masterBox fill:#fff,stroke:#000,stroke-width:1.5px;
    classDef slaveBox fill:#fff,stroke:#000,stroke-width:1.5px;
    classDef busBox fill:#fff,stroke:#000,stroke-width:1.5px;
    classDef logic fill:#fff,stroke:#000,stroke-width:1px,stroke-dasharray: 5 5;
    classDef plain fill:#fff,stroke:#000,stroke-width:1px;

    %% External
    ExtBus1[External Bus]:::logic
    ExtBus2[External Bus]:::logic
    
    %% Main System Boundary
    subgraph FPGA [ ]
        direction TB

        %% Top: Masters
        subgraph M2_Complex [Master 2 Interface<br>Bridge Master<br>(Low Priority)]
            direction TB
            UART_M2[UART Transceiver]:::plain
            Ctrl_M2[Bridge Controller]:::plain
        end
        class M2_Complex masterBox

        M1[Master 1 Interface<br>(High Priority)]:::masterBox

        %% Middle: Bus Interconnect
        subgraph Interconnect [Bus Interconnect Matrix]
            direction LR
            Arbiter{Arbiter}:::plain
            MuxRouting(Mux / Routing):::plain
            Decoder(Addr Decoder):::plain
        end
        class Interconnect busBox

        %% Bottom: Slaves
        subgraph S3_Complex [Slave 3<br>(Bridge)<br>Split supported]
            direction TB
            Ctrl_S3[Bridge Controller]:::plain
            UART_S3[UART Transceiver]:::plain
        end
        class S3_Complex slaveBox

        S2[Slave 2 -<br>4K memory]:::slaveBox
        S1[Slave 1 -<br>2K memory]:::slaveBox

    end
    class FPGA container

    %% Connections
    
    %% External Links
    ExtBus1 <-->|TX/RX| UART_M2
    UART_S3 <-->|TX / RX| ExtBus2

    %% Internal Master 2
    UART_M2 --- Ctrl_M2
    Ctrl_M2 -->|Request / Grant,<br>Addr / Data| MuxRouting
    Ctrl_M2 -.->|breq| Arbiter

    %% Internal Master 1
    M1 -->|Request / Grant,<br>Addr / Data| MuxRouting

    %% Interconnect Internal
    Arbiter -.-> MuxRouting
    Decoder -.-> MuxRouting

    %% Interconnect to Slaves
    MuxRouting ==>|Read Data| S3_Complex
    MuxRouting ==>|Select / Writes| S3_Complex

    MuxRouting ==>|Read Data| S2
    MuxRouting ==>|Select / Writes| S2

    MuxRouting ==>|Read Data| S1
    MuxRouting ==>|Select / Writes| S1

    %% Decoder Control
    Decoder -.->|ssplit and split_grant| Arbiter
    
    %% Bridge Slave Internal
    Ctrl_S3 <-->|FIFO / UART| UART_S3
